<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¼€ë§ˆ KEMA - ë³¸ì‚¬ í†µí•© ê´€ë¦¬</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div class="container">
        <!-- í—¤ë” -->
        <header class="header">
            <h1>ğŸ¢ ì¼€ë§ˆ KEMA</h1>
            <p>ë³¸ì‚¬ í†µí•© ê´€ë¦¬ - ê¸°ê´€ ê´€ë¦¬</p>
        </header>

        <!-- ìš”ì•½ ì¹´ë“œ -->
        <div class="summary-cards">
            <div class="summary-card">
                <div class="summary-card-icon">ğŸ¥</div>
                <div class="summary-card-content">
                    <div class="summary-card-value" id="totalOrganizations">0</div>
                    <div class="summary-card-label">ì „ì²´ ê¸°ê´€</div>
                </div>
            </div>
            <div class="summary-card">
                <div class="summary-card-icon">ğŸ‘¥</div>
                <div class="summary-card-content">
                    <div class="summary-card-value" id="totalAllCaregivers">0</div>
                    <div class="summary-card-label">ì „ì²´ ë³´í˜¸ì‚¬</div>
                </div>
            </div>
            <div class="summary-card">
                <div class="summary-card-icon">ğŸ“¨</div>
                <div class="summary-card-content">
                    <div class="summary-card-value" id="activeNotifications">0</div>
                    <div class="summary-card-label">í™œì„± ì•Œë¦¼í†¡ ì„¤ì •</div>
                </div>
            </div>
        </div>

        <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
        <nav class="tabs-nav">
            <button class="tab-btn active" onclick="switchTab('org-tab')">ìš”ì–‘ê¸°ê´€ ê´€ë¦¬</button>
            <button class="tab-btn" onclick="switchTab('edu-tab')">êµìœ¡ì½˜í…ì¸  ê´€ë¦¬</button>
        </nav>

        <!-- íƒ­ 1: ìš”ì–‘ê¸°ê´€ ê´€ë¦¬ -->
        <div id="org-tab" class="tab-content active">
            <!-- ë°±ì—”ë“œ ìŠ¤ì¼€ì¤„ëŸ¬ ì‹œë®¬ë ˆì´ì…˜ -->
            <div class="card mb-md" style="border-left: 5px solid var(--warning-500);">
                <div class="card-header">
                    <div style="display: flex; align-items: center; gap: var(--spacing-sm);">
                        <h2 class="card-title">ğŸ¤– ìë™í™” ì‹œìŠ¤í…œ ëª¨ë‹ˆí„°ë§ (ë°±ì—”ë“œ ì‹œë®¬ë ˆì´ì…˜)</h2>
                        <span id="schedulerStatus" class="badge badge-warning">ì¤‘ì§€ë¨</span>
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-primary" id="btnStartScheduler" onclick="toggleScheduler()">
                            â–¶ ì‹œìŠ¤í…œ ê°€ë™
                        </button>
                        <button class="btn btn-secondary" onclick="clearSystemLogs()">
                            ì§€ìš°ê¸°
                        </button>
                    </div>
                </div>
                <div class="card-body" style="padding: var(--spacing-md);">
                    <div id="systemLogs" style="
                    background: #1e1e1e; 
                    color: #d4d4d4; 
                    font-family: 'Consolas', monospace; 
                    padding: var(--spacing-md); 
                    border-radius: var(--radius-md); 
                    height: 200px; 
                    overflow-y: auto; 
                    font-size: 0.85rem;
                    line-height: 1.5;
                ">
                        <div>[System] ì¤€ë¹„ ì™„ë£Œ. 'ì‹œìŠ¤í…œ ê°€ë™' ë²„íŠ¼ì„ ëˆŒëŸ¬ ë°±ì—”ë“œ ìŠ¤ì¼€ì¤„ëŸ¬ë¥¼ ì‹œì‘í•˜ì„¸ìš”.</div>
                        <div>[System] ì„¤ì •: ë§¤ 10ì´ˆë§ˆë‹¤ í˜„ì¬ ì‹œê°„ê³¼ ì¼ì¹˜í•˜ëŠ” ì•Œë¦¼ ì„¤ì •ì„ í™•ì¸í•©ë‹ˆë‹¤.</div>
                    </div>
                </div>
            </div>

            <!-- ê¸°ê´€ ê´€ë¦¬ í…Œì´ë¸” -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">ê¸°ê´€ í†µí•© ê´€ë¦¬</h2>
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="openOrgModal()">
                            â• ê¸°ê´€ ì¶”ê°€
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ê¸°ê´€ëª…</th>
                                    <th>ì„¼í„°ì¥ëª…</th>
                                    <th>ì—°ë½ì²˜</th>
                                    <th>ì†Œì† ë³´í˜¸ì‚¬ ìˆ˜</th>
                                    <th>êµìœ¡ëª…</th>
                                    <th>ë°œì†¡ ìš”ì¼</th>
                                    <th>ë°œì†¡ ì‹œê°„</th>
                                    <th>ìƒíƒœ</th>
                                    <th>ì‘ì—…</th>
                                </tr>
                            </thead>
                            <tbody id="organizationsTableBody">
                                <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- íƒ­ 2: êµìœ¡ì½˜í…ì¸  ê´€ë¦¬ -->
        <div id="edu-tab" class="tab-content">
            <!-- êµìœ¡ ìš”ì•½ ì¹´ë“œ -->
            <div class="summary-cards" style="margin-bottom: var(--spacing-lg);">
                <div class="summary-card">
                    <div class="summary-card-icon">ğŸ“š</div>
                    <div class="summary-card-content">
                        <div class="summary-card-value" id="totalEducationContents">0</div>
                        <div class="summary-card-label">êµìœ¡ìë£Œ ì´ìˆ˜</div>
                    </div>
                </div>
                <div class="summary-card">
                    <div class="summary-card-icon">âœ…</div>
                    <div class="summary-card-content">
                        <div class="summary-card-value" id="mandatoryEducationCount">0</div>
                        <div class="summary-card-label">í•„ìˆ˜ êµìœ¡</div>
                    </div>
                </div>
            </div>

            <!-- êµìœ¡ì½˜í…ì¸  ê´€ë¦¬ í…Œì´ë¸” -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">êµìœ¡ì½˜í…ì¸  ê´€ë¦¬</h2>
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="openEduModal()">
                            â• êµìœ¡ìë£Œ ì¶”ê°€
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>êµìœ¡ëª…</th>
                                    <th>ì¹´í…Œê³ ë¦¬</th>
                                    <th>ì½˜í…ì¸  íƒ€ì…</th>
                                    <th>í•„ìˆ˜ì—¬ë¶€</th>
                                    <th>ìƒíƒœ</th>
                                    <th>ì‘ì—…</th>
                                </tr>
                            </thead>
                            <tbody id="educationTableBody">
                                <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- íƒ­ ì „í™˜ ë¸ë¦¬ê²Œì´íŠ¸ë¥¼ ìœ„í•œ ì»¨í…Œì´ë„ˆ ë‹«ê¸° -->
    </div>

    <!-- ê¸°ê´€ ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ -->
    <div id="orgModal" class="modal-overlay hidden">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title" id="orgModalTitle">ê¸°ê´€ ì¶”ê°€</h3>
                <button class="modal-close" onclick="closeOrgModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="orgForm">
                    <div class="form-group mb-md">
                        <label class="form-label required">ê¸°ê´€ëª…</label>
                        <input type="text" id="orgNameInput" class="form-input" required>
                    </div>
                    <div class="form-group mb-md">
                        <label class="form-label required">ì„¼í„°ì¥ëª…</label>
                        <input type="text" id="orgDirectorInput" class="form-input" required>
                    </div>
                    <div class="form-group mb-md">
                        <label class="form-label required">ì—°ë½ì²˜</label>
                        <input type="text" id="orgPhoneInput" class="form-input" required>
                    </div>
                    <div class="form-group mb-md">
                        <label class="form-label">ì£¼ì†Œ</label>
                        <input type="text" id="orgAddressInput" class="form-input">
                    </div>
                    <div class="form-group bg-neutral-50 p-md rounded">
                        <label class="form-label">ìƒíƒœ</label>
                        <select id="orgStatusInput" class="form-select">
                            <option value="active">í™œì„± (Active)</option>
                            <option value="suspended">ì •ì§€ (Suspended)</option>
                            <option value="inactive">ë¹„í™œì„± (Inactive)</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeOrgModal()">ì·¨ì†Œ</button>
                <button class="btn btn-primary" onclick="saveOrganization()">ì €ì¥</button>
            </div>
        </div>
    </div>

    <!-- ê¸°ê´€ ìƒì„¸ ì •ë³´ ëª¨ë‹¬ -->
    <div id="detailModal" class="modal-overlay hidden">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
                <h3 class="modal-title" id="detailModalTitle">ê¸°ê´€ ìƒì„¸ ì •ë³´</h3>
                <button class="modal-close" onclick="closeDetailModal()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- ê¸°ê´€ ê¸°ë³¸ ì •ë³´ -->
                <h4 class="form-label"
                    style="margin-bottom: var(--spacing-sm); font-size: 1.1rem; border-bottom: 2px solid var(--primary-100); padding-bottom: 8px;">
                    ğŸ¢ ê¸°ê´€ ì •ë³´</h4>
                <div id="detailOrgInfo"
                    style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-md); margin-bottom: var(--spacing-xl);">
                    <!-- JSë¡œ ë Œë”ë§ -->
                </div>

                <!-- ì†Œì† ë³´í˜¸ì‚¬ ëª©ë¡ -->
                <div
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-sm); border-bottom: 2px solid var(--primary-100); padding-bottom: 8px;">
                    <h4 class="form-label" style="margin-bottom: 0; font-size: 1.1rem;">ğŸ‘¥ ì†Œì† ìš”ì–‘ë³´í˜¸ì‚¬</h4>
                    <span class="badge badge-primary" id="caregiverCount">0ëª…</span>
                </div>

                <div class="table-container"
                    style="max-height: 300px; overflow-y: auto; border: 1px solid var(--neutral-200); border-radius: var(--radius-md);">
                    <table class="table">
                        <thead style="position: sticky; top: 0; background: var(--neutral-50); z-index: 1;">
                            <tr>
                                <th>ì´ë¦„</th>
                                <th>ì—°ë½ì²˜</th>
                                <th>ìƒíƒœ</th>
                            </tr>
                        </thead>
                        <tbody id="detailCaregiverTableBody">
                            <!-- JSë¡œ ë Œë”ë§ -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="closeDetailModal()">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <style>
        .info-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .info-item.full-width {
            grid-column: span 2;
        }

        .info-label {
            font-size: 0.8rem;
            color: var(--neutral-500);
            font-weight: 600;
        }

        .info-value {
            font-size: 1rem;
            color: var(--neutral-800);
            font-weight: 500;
        }
    </style>

    <!-- ë°œì†¡ ì„¤ì • ëª¨ë‹¬ -->
    <div id="notificationModal" class="modal-overlay hidden">
        <div class="modal" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">ì•Œë¦¼í†¡ ë°œì†¡ ì„¤ì •</h3>
                <button class="modal-close" onclick="closeNotificationModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group mb-md">
                    <label class="form-label">ê¸°ê´€ëª…</label>
                    <div id="orgName"
                        style="font-weight: 600; color: var(--neutral-900); padding: var(--spacing-sm) 0;"></div>
                </div>
                <form id="notificationForm">
                    <!-- êµìœ¡ ì½˜í…ì¸  ì„ íƒ -->
                    <div class="form-group mb-md">
                        <label class="form-label required" for="educationContent">êµìœ¡ ì½˜í…ì¸ </label>
                        <select id="educationContent" class="form-select" required>
                            <option value="">êµìœ¡ì„ ì„ íƒí•˜ì„¸ìš”</option>
                            <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
                        </select>
                        <small
                            style="color: var(--neutral-600); font-size: var(--font-size-xs); margin-top: var(--spacing-xs);">
                            ì´ ê¸°ê´€ì— ë°œì†¡í•  êµìœ¡ ìë£Œë¥¼ ì„ íƒí•˜ì„¸ìš”
                        </small>
                    </div>

                    <!-- ë°œì†¡ ì‹œê°„ -->
                    <div class="form-group mb-md">
                        <label class="form-label required" for="sendTime">ë°œì†¡ ì‹œê°„</label>
                        <input type="time" id="sendTime" class="form-input" required>
                    </div>

                    <!-- ë°œì†¡ ìš”ì¼ ì„ íƒ -->
                    <div class="form-group mb-md">
                        <label class="form-label required">ë°œì†¡ ìš”ì¼</label>
                        <div class="weekday-selector">
                            <label class="weekday-checkbox">
                                <input type="checkbox" name="weekday" value="ì›”">
                                <span>ì›”</span>
                            </label>
                            <label class="weekday-checkbox">
                                <input type="checkbox" name="weekday" value="í™”">
                                <span>í™”</span>
                            </label>
                            <label class="weekday-checkbox">
                                <input type="checkbox" name="weekday" value="ìˆ˜">
                                <span>ìˆ˜</span>
                            </label>
                            <label class="weekday-checkbox">
                                <input type="checkbox" name="weekday" value="ëª©">
                                <span>ëª©</span>
                            </label>
                            <label class="weekday-checkbox">
                                <input type="checkbox" name="weekday" value="ê¸ˆ">
                                <span>ê¸ˆ</span>
                            </label>
                            <label class="weekday-checkbox">
                                <input type="checkbox" name="weekday" value="í† ">
                                <span>í† </span>
                            </label>
                            <label class="weekday-checkbox">
                                <input type="checkbox" name="weekday" value="ì¼">
                                <span>ì¼</span>
                            </label>
                        </div>
                    </div>

                    <!-- ë©”ì‹œì§€ í¸ì§‘ -->
                    <div class="form-group mb-md">
                        <label class="form-label required" for="messageTemplate">ì•Œë¦¼í†¡ ë©”ì‹œì§€</label>
                        <textarea id="messageTemplate" class="form-textarea" rows="6" required
                            placeholder="ì•Œë¦¼í†¡ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                        <div class="message-variables">
                            <small style="color: var(--neutral-600); font-size: var(--font-size-xs);">
                                ì‚¬ìš© ê°€ëŠ¥í•œ ë³€ìˆ˜:
                                <button type="button" class="variable-tag" onclick="insertVariable('{ê¸°ê´€ëª…}')">
                                    {ê¸°ê´€ëª…}
                                </button>
                                <button type="button" class="variable-tag" onclick="insertVariable('{ë³´í˜¸ì‚¬ëª…}')">
                                    {ë³´í˜¸ì‚¬ëª…}
                                </button>
                                <button type="button" class="variable-tag" onclick="insertVariable('{êµìœ¡ëª…}')">
                                    {êµìœ¡ëª…}
                                </button>
                                <button type="button" class="variable-tag" onclick="insertVariable('{ë°œì†¡ì¼ì‹œ}')">
                                    {ë°œì†¡ì¼ì‹œ}
                                </button>
                            </small>
                        </div>
                    </div>

                    <!-- ë¯¸ë¦¬ë³´ê¸° -->
                    <div class="form-group mb-md">
                        <label class="form-label">ë©”ì‹œì§€ ë¯¸ë¦¬ë³´ê¸°</label>
                        <div class="message-preview" id="messagePreview">
                            ë¯¸ë¦¬ë³´ê¸°ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
                        </div>
                        <button type="button" class="btn btn-sm btn-secondary mt-md" onclick="updatePreview()">
                            ğŸ”„ ë¯¸ë¦¬ë³´ê¸° ìƒˆë¡œê³ ì¹¨
                        </button>
                    </div>

                    <!-- í™œì„±í™” ì²´í¬ë°•ìŠ¤ -->
                    <div class="form-group">
                        <label class="form-label" style="display: flex; align-items: center; gap: var(--spacing-sm);">
                            <input type="checkbox" id="isActive" style="width: 18px; height: 18px;">
                            <span>ì•Œë¦¼í†¡ ë°œì†¡ í™œì„±í™”</span>
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeNotificationModal()">ì·¨ì†Œ</button>
                <button class="btn btn-primary" onclick="saveNotificationSettings()">ì €ì¥</button>
            </div>
        </div>
    </div>

    <!-- êµìœ¡ ì½˜í…ì¸  ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ -->
    <div id="eduModal" class="modal-overlay hidden">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title" id="eduModalTitle">êµìœ¡ìë£Œ ì¶”ê°€</h3>
                <button class="modal-close" onclick="closeEduModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="eduForm">
                    <div class="form-group mb-md">
                        <label class="form-label required">êµìœ¡ëª…</label>
                        <input type="text" id="eduTitleInput" class="form-input" required>
                    </div>
                    <div class="form-group mb-md">
                        <label class="form-label">êµìœ¡ ì„¤ëª…</label>
                        <textarea id="eduDescriptionInput" class="form-textarea" rows="3"></textarea>
                    </div>
                    <div class="form-group mb-md">
                        <label class="form-label required">ì¹´í…Œê³ ë¦¬</label>
                        <input type="text" id="eduCategoryInput" class="form-input" placeholder="ì˜ˆ: ê°ì—¼ê´€ë¦¬, ì•ˆì „êµìœ¡"
                            required>
                    </div>
                    <div class="form-group mb-md" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div>
                            <label class="form-label required">ì½˜í…ì¸  íƒ€ì…</label>
                            <select id="eduTypeInput" class="form-select">
                                <option value="video">ë™ì˜ìƒ (Video)</option>
                                <option value="document">ë¬¸ì„œ (Document)</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label">êµìœ¡ ì‹œê°„ (ë¶„)</label>
                            <input type="number" id="eduDurationInput" class="form-input" value="60">
                        </div>
                    </div>
                    <div class="form-group mb-md">
                        <label class="form-label required">ì½˜í…ì¸  URL</label>
                        <input type="url" id="eduUrlInput" class="form-input" placeholder="https://" required>
                    </div>
                    <div style="display: flex; gap: 20px; margin-top: 20px;" class="bg-neutral-50 p-md rounded">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="eduMandatoryInput" style="width: 18px; height: 18px;">
                            <span style="font-weight: 500;">í•„ìˆ˜ êµìœ¡ ì„¤ì •</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="eduActiveInput" checked style="width: 18px; height: 18px;">
                            <span style="font-weight: 500;">í™œì„±í™”</span>
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeEduModal()">ì·¨ì†Œ</button>
                <button class="btn btn-primary" onclick="saveEducationContent()">ì €ì¥</button>
            </div>
        </div>
    </div>

    <script src="mockData.js"></script>
    <script>
        // í˜„ì¬ í¸ì§‘ ì¤‘ì¸ IDë“¤
        let editingOrganizationId = null;
        let editingOrgDataId = null;
        let editingEduId = null;

        let organizations = []; // ë¡œì»¬ ë°ì´í„°
        let educationContents = []; // êµìœ¡ ì½˜í…ì¸  ë¡œì»¬ ë°ì´í„°

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
            initData();
            loadOrganizations();
            loadEducationTable();
            updateSummaryCards();
            updateEduSummary();
        });

        // ë°ì´í„° ì´ˆê¸°í™”
        function initData() {
            // ê¸°ê´€ ë°ì´í„°
            const storedOrgs = localStorage.getItem('kema_organizations');
            if (storedOrgs) {
                organizations = JSON.parse(storedOrgs);
            } else {
                organizations = [...mockOrganizations];
                localStorage.setItem('kema_organizations', JSON.stringify(organizations));
            }

            // êµìœ¡ ì½˜í…ì¸  ë°ì´í„°
            const storedEdu = localStorage.getItem('kema_education_contents');
            if (storedEdu) {
                educationContents = JSON.parse(storedEdu);
            } else {
                educationContents = [...mockEducationContents];
                localStorage.setItem('kema_education_contents', JSON.stringify(educationContents));
            }
        }

        // íƒ­ ì „í™˜ í•¨ìˆ˜
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));

            document.getElementById(tabId).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        // ìš”ì•½ ì¹´ë“œ ì—…ë°ì´íŠ¸
        function updateSummaryCards() {
            const totalOrgs = organizations.length;
            const totalCaregivers = mockCaregivers.length;
            const activeNotifications = mockNotificationSettings.filter(s => s.is_active).length;

            document.getElementById('totalOrganizations').textContent = totalOrgs;
            document.getElementById('totalAllCaregivers').textContent = totalCaregivers;
            document.getElementById('activeNotifications').textContent = activeNotifications;
        }

        // êµìœ¡ ìš”ì•½ ì—…ë°ì´íŠ¸
        function updateEduSummary() {
            document.getElementById('totalEducationContents').textContent = educationContents.length;
            document.getElementById('mandatoryEducationCount').textContent = educationContents.filter(e => e.is_mandatory).length;
        }

        // ê¸°ê´€ë³„ ë³´í˜¸ì‚¬ ìˆ˜ ê³„ì‚°
        function getCaregiversCount(organizationId) {
            return mockCaregivers.filter(c => c.organization_id === organizationId).length;
        }

        // ê¸°ê´€ë³„ ë°œì†¡ ì„¤ì • ê°€ì ¸ì˜¤ê¸°
        function getNotificationSettings(organizationId) {
            return mockNotificationSettings.find(s => s.organization_id === organizationId);
        }

        // ê¸°ê´€ ëª©ë¡ ë¡œë“œ
        function loadOrganizations() {
            const tbody = document.getElementById('organizationsTableBody');

            tbody.innerHTML = organizations.map(org => {
                const caregiversCount = getCaregiversCount(org.id);
                const settings = getNotificationSettings(org.id);

                // êµìœ¡ ì½˜í…ì¸  ì´ë¦„ ê°€ì ¸ì˜¤ê¸° (ë¡œì»¬ ë°ì´í„° ê¸°ì¤€)
                let educationName = '-';
                if (settings && settings.education_content_id) {
                    const education = educationContents.find(e => e.id === settings.education_content_id);
                    if (education) {
                        educationName = education.title;
                    }
                }

                return `
          <tr>
            <td><strong>${org.name}</strong></td>
            <td>${org.director_name}</td>
            <td>${org.phone}</td>
            <td>
              <span class="badge badge-info">${caregiversCount}ëª…</span>
            </td>
            <td>${educationName}</td>
            <td>${settings ? settings.send_days : '-'}</td>
            <td>${settings ? formatTime(settings.send_time) : '-'}</td>
            <td>${getStatusBadge(org.status)}</td>
            <td>
              <div class="action-buttons" style="display: grid; grid-template-columns: 1fr 1fr; gap: 4px; min-width: 140px;">
                <button class="btn btn-sm btn-primary" onclick="openNotificationModal(${org.id})" style="grid-column: span 2;">
                  âš™ï¸ ë°œì†¡
                </button>
                <button class="btn btn-sm btn-secondary" onclick="viewDetails(${org.id})">
                  ğŸ‘ï¸ ìƒì„¸
                </button>
                <button class="btn btn-sm btn-secondary" onclick="openOrgModal(${org.id})">
                  âœï¸ ìˆ˜ì •
                </button>
                <button class="btn btn-sm btn-danger" onclick="deleteOrganization(${org.id})" style="grid-column: span 2;">
                  ğŸ—‘ï¸ ì‚­ì œ
                </button>
              </div>
            </td>
          </tr>
        `;
            }).join('');
        }

        // ê¸°ê´€ ê´€ë¦¬ ëª¨ë‹¬ ì—´ê¸°
        function openOrgModal(orgId = null) {
            editingOrgDataId = orgId;
            const title = document.getElementById('orgModalTitle');
            const form = document.getElementById('orgForm');

            if (orgId) {
                // ìˆ˜ì •
                const org = organizations.find(o => o.id === orgId);
                if (!org) return;
                title.textContent = 'ê¸°ê´€ ì •ë³´ ìˆ˜ì •';
                document.getElementById('orgNameInput').value = org.name;
                document.getElementById('orgDirectorInput').value = org.director_name;
                document.getElementById('orgPhoneInput').value = org.phone;
                document.getElementById('orgAddressInput').value = org.address || '';
                document.getElementById('orgStatusInput').value = org.status;
            } else {
                // ì¶”ê°€
                title.textContent = 'ê¸°ê´€ ì¶”ê°€';
                form.reset();
                document.getElementById('orgStatusInput').value = 'active';
            }

            document.getElementById('orgModal').classList.remove('hidden');
        }

        // ê¸°ê´€ ê´€ë¦¬ ëª¨ë‹¬ ë‹«ê¸°
        function closeOrgModal() {
            document.getElementById('orgModal').classList.add('hidden');
            editingOrgDataId = null;
        }

        // ê¸°ê´€ ì €ì¥ (ì¶”ê°€/ìˆ˜ì •)
        function saveOrganization() {
            const name = document.getElementById('orgNameInput').value;
            const director = document.getElementById('orgDirectorInput').value;
            const phone = document.getElementById('orgPhoneInput').value;
            const address = document.getElementById('orgAddressInput').value;
            const status = document.getElementById('orgStatusInput').value;

            if (!name || !director || !phone) {
                alert('í•„ìˆ˜ í•­ëª©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            if (editingOrgDataId) {
                // ìˆ˜ì •
                const index = organizations.findIndex(o => o.id === editingOrgDataId);
                if (index !== -1) {
                    organizations[index] = { ...organizations[index], name, director_name: director, phone, address, status };
                }
            } else {
                // ì¶”ê°€
                const newId = organizations.length > 0 ? Math.max(...organizations.map(o => o.id)) + 1 : 1;
                organizations.push({
                    id: newId,
                    name,
                    director_name: director,
                    phone,
                    address,
                    business_number: '000-00-00000', // ì„ì‹œ
                    status,
                    email: '-'
                });
            }

            localStorage.setItem('kema_organizations', JSON.stringify(organizations));
            closeOrgModal();
            loadOrganizations();
            updateSummaryCards();
        }

        // ê¸°ê´€ ì‚­ì œ
        function deleteOrganization(id) {
            if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            organizations = organizations.filter(o => o.id !== id);
            localStorage.setItem('kema_organizations', JSON.stringify(organizations));
            loadOrganizations();
            updateSummaryCards();
        }

        // ì‹œê°„ í¬ë§·íŒ… (HH:MM:SS -> HH:MM)
        function formatTime(timeString) {
            if (!timeString) return '-';
            return timeString.substring(0, 5);
        }

        // ìƒíƒœ ë°°ì§€ ìƒì„±
        function getStatusBadge(status) {
            const statusMap = {
                'active': { label: 'í™œì„±', class: 'badge-success' },
                'inactive': { label: 'ë¹„í™œì„±', class: 'badge-warning' },
                'suspended': { label: 'ì •ì§€', class: 'badge-danger' }
            };
            const { label, class: badgeClass } = statusMap[status] || { label: status, class: 'badge-info' };
            return `<span class="badge ${badgeClass}">${label}</span>`;
        }

        // ì•Œë¦¼í†¡ ë°œì†¡ ì„¤ì • ëª¨ë‹¬ ì—´ê¸°
        function openNotificationModal(organizationId) {
            editingOrganizationId = organizationId;
            const org = organizations.find(o => o.id === organizationId);
            const settings = getNotificationSettings(organizationId);

            if (!org) return;

            document.getElementById('orgName').textContent = org.name;

            // êµìœ¡ ì½˜í…ì¸  ëª©ë¡ ë¡œë“œ
            loadEducationContents();

            if (settings) {
                // êµìœ¡ ì½˜í…ì¸  ì„ íƒ
                document.getElementById('educationContent').value = settings.education_content_id;

                document.getElementById('sendTime').value = formatTime(settings.send_time);

                // ìš”ì¼ ì²´í¬ë°•ìŠ¤ ì„¤ì •
                const weekdays = settings.send_days.split(',');
                document.querySelectorAll('input[name="weekday"]').forEach(checkbox => {
                    checkbox.checked = weekdays.includes(checkbox.value);
                });

                // ë©”ì‹œì§€ í…œí”Œë¦¿ ì„¤ì •
                document.getElementById('messageTemplate').value = settings.message_template || getDefaultMessageTemplate();

                document.getElementById('isActive').checked = settings.is_active;
            } else {
                document.getElementById('notificationForm').reset();
                document.getElementById('isActive').checked = true;
                document.getElementById('messageTemplate').value = getDefaultMessageTemplate();
            }

            // ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
            updatePreview();

            document.getElementById('notificationModal').classList.remove('hidden');
        }

        // êµìœ¡ ì½˜í…ì¸  ëª©ë¡ ë¡œë“œ (ë°œì†¡ ì„¤ì • ëª¨ë‹¬ìš©)
        function loadEducationContents() {
            const select = document.getElementById('educationContent');

            // ê¸°ì¡´ ì˜µì…˜ ì œê±° (ì²« ë²ˆì§¸ placeholder ì œì™¸)
            while (select.options.length > 1) {
                select.remove(1);
            }

            // í™œì„±í™”ëœ êµìœ¡ ì½˜í…ì¸ ë§Œ ë¡œë“œ (ë¡œì»¬ ë°ì´í„° ê¸°ì¤€)
            const activeContents = educationContents.filter(c => c.status === 'active');

            activeContents.forEach(content => {
                const option = document.createElement('option');
                option.value = content.id;
                option.textContent = `${content.title} ${content.is_mandatory ? '(í•„ìˆ˜)' : ''}`;
                select.appendChild(option);
            });
        }

        // ê¸°ë³¸ ë©”ì‹œì§€ í…œí”Œë¦¿
        function getDefaultMessageTemplate() {
            return `ì•ˆë…•í•˜ì„¸ìš”, {ê¸°ê´€ëª…}ì…ë‹ˆë‹¤.

{ë³´í˜¸ì‚¬ëª…}ë‹˜, {êµìœ¡ëª…} êµìœ¡ì„ ìˆ˜ê°•í•´ì£¼ì„¸ìš”.

êµìœ¡ ì¼ì •: {ë°œì†¡ì¼ì‹œ}

êµìœ¡ì„ ì™„ë£Œí•˜ì‹œë©´ ì´ìˆ˜ì¦ì´ ë°œê¸‰ë©ë‹ˆë‹¤.

ê°ì‚¬í•©ë‹ˆë‹¤.`;
        }

        // ë³€ìˆ˜ ì‚½ì… í•¨ìˆ˜
        function insertVariable(variable) {
            const textarea = document.getElementById('messageTemplate');
            const cursorPos = textarea.selectionStart;
            const textBefore = textarea.value.substring(0, cursorPos);
            const textAfter = textarea.value.substring(cursorPos);

            textarea.value = textBefore + variable + textAfter;
            textarea.focus();
            textarea.selectionStart = textarea.selectionEnd = cursorPos + variable.length;

            // ë¯¸ë¦¬ë³´ê¸° ìë™ ì—…ë°ì´íŠ¸
            updatePreview();
        }

        // ë©”ì‹œì§€ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
        function updatePreview() {
            const org = organizations.find(o => o.id === editingOrganizationId);
            if (!org) return;

            const template = document.getElementById('messageTemplate').value;
            const sampleCaregiver = mockCaregivers.find(c => c.organization_id === editingOrganizationId);
            const sampleEducation = educationContents[0];

            // ë³€ìˆ˜ ì¹˜í™˜
            let preview = template
                .replace(/{ê¸°ê´€ëª…}/g, org.name)
                .replace(/{ë³´í˜¸ì‚¬ëª…}/g, sampleCaregiver ? sampleCaregiver.name : 'í™ê¸¸ë™')
                .replace(/{êµìœ¡ëª…}/g, sampleEducation ? sampleEducation.title : 'ê°ì—¼ ê´€ë¦¬ ê¸°ë³¸ êµìœ¡')
                .replace(/{ë°œì†¡ì¼ì‹œ}/g, new Date().toLocaleString('ko-KR'));

            document.getElementById('messagePreview').textContent = preview;
        }

        // ëª¨ë‹¬ ë‹«ê¸°
        function closeNotificationModal() {
            document.getElementById('notificationModal').classList.add('hidden');
            editingOrganizationId = null;
        }

        // ì•Œë¦¼í†¡ ì„¤ì • ì €ì¥
        function saveNotificationSettings() {
            const educationContentId = parseInt(document.getElementById('educationContent').value);
            const sendTime = document.getElementById('sendTime').value;
            const isActive = document.getElementById('isActive').checked;
            const messageTemplate = document.getElementById('messageTemplate').value;

            // ì„ íƒëœ ìš”ì¼ ê°€ì ¸ì˜¤ê¸°
            const selectedWeekdays = Array.from(document.querySelectorAll('input[name="weekday"]:checked'))
                .map(checkbox => checkbox.value);

            // ìœ íš¨ì„± ê²€ì‚¬
            if (!educationContentId) {
                alert('êµìœ¡ ì½˜í…ì¸ ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            if (!sendTime) {
                alert('ë°œì†¡ ì‹œê°„ì€ í•„ìˆ˜ ì…ë ¥ í•­ëª©ì…ë‹ˆë‹¤.');
                return;
            }

            if (selectedWeekdays.length === 0) {
                alert('ìµœì†Œ 1ê°œ ì´ìƒì˜ ë°œì†¡ ìš”ì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            if (!messageTemplate.trim()) {
                alert('ì•Œë¦¼í†¡ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            const existingIndex = mockNotificationSettings.findIndex(
                s => s.organization_id === editingOrganizationId
            );

            const settingData = {
                organization_id: editingOrganizationId,
                education_content_id: educationContentId,
                send_time: sendTime + ':00',
                send_days: selectedWeekdays.join(','),
                message_template: messageTemplate,
                is_active: isActive
            };

            if (existingIndex !== -1) {
                // ìˆ˜ì •
                mockNotificationSettings[existingIndex] = {
                    ...mockNotificationSettings[existingIndex],
                    ...settingData
                };
            } else {
                // ì¶”ê°€
                const newId = Math.max(...mockNotificationSettings.map(s => s.id)) + 1;
                mockNotificationSettings.push({
                    id: newId,
                    ...settingData
                });
            }

            closeNotificationModal();
            loadOrganizations();
            updateSummaryCards();

            const selectedContent = mockEducationContents.find(c => c.id === educationContentId);
            alert(`ì•Œë¦¼í†¡ ë°œì†¡ ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.\nêµìœ¡: ${selectedContent ? selectedContent.title : ''}`);
        }

        // ê¸°ê´€ ìƒì„¸ ë³´ê¸°
        function viewDetails(organizationId) {
            const org = organizations.find(o => o.id === organizationId);
            const caregivers = mockCaregivers.filter(c => c.organization_id === organizationId);

            if (!org) return;

            // ëª¨ë‹¬ ì œëª© ì„¤ì •
            document.getElementById('detailModalTitle').textContent = `${org.name} ìƒì„¸ ì •ë³´`;

            // ê¸°ê´€ ê¸°ë³¸ ì •ë³´ ë Œë”ë§
            const infoContainer = document.getElementById('detailOrgInfo');
            infoContainer.innerHTML = `
                <div class="info-item">
                    <span class="info-label">ì„¼í„°ì¥ëª…</span>
                    <span class="info-value">${org.director_name}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">ì—°ë½ì²˜</span>
                    <span class="info-value">${org.phone}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">ì´ë©”ì¼</span>
                    <span class="info-value">${org.email || '-'}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">ì‚¬ì—…ìë²ˆí˜¸</span>
                    <span class="info-value">${org.business_number}</span>
                </div>
                <div class="info-item full-width">
                    <span class="info-label">ì£¼ì†Œ</span>
                    <span class="info-value">${org.address || '-'}</span>
                </div>
            `;

            // ì†Œì† ë³´í˜¸ì‚¬ ëª©ë¡ ë Œë”ë§
            const caregiverTbody = document.getElementById('detailCaregiverTableBody');
            if (caregivers.length === 0) {
                caregiverTbody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: var(--neutral-500);">ë“±ë¡ëœ ë³´í˜¸ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
            } else {
                caregiverTbody.innerHTML = caregivers.map((c, idx) => `
                    <tr>
                        <td>${c.name}</td>
                        <td>${c.phone}</td>
                        <td>${getStatusBadge(c.status)}</td>
                    </tr>
                `).join('');
            }

            document.getElementById('caregiverCount').textContent = `${caregivers.length}ëª…`;

            // ëª¨ë‹¬ ì—´ê¸°
            document.getElementById('detailModal').classList.remove('hidden');
        }

        // ìƒì„¸ ëª¨ë‹¬ ë‹«ê¸°
        function closeDetailModal() {
            document.getElementById('detailModal').classList.add('hidden');
        }

        // ìƒíƒœ í…ìŠ¤íŠ¸ ë³€í™˜
        function getStatusText(status) {
            const statusMap = {
                'active': 'ì¬ì§ ì¤‘',
                'inactive': 'íœ´ì§',
                'resigned': 'í‡´ì‚¬'
            };
            return statusMap[status] || status;
        }

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        document.getElementById('notificationModal').addEventListener('click', (e) => {
            if (e.target.id === 'notificationModal') {
                closeNotificationModal();
            }
        });

        /* =========================================
           êµìœ¡ ì½˜í…ì¸  ê´€ë¦¬ ë¡œì§
           ========================================= */

        // êµìœ¡ ì½˜í…ì¸  í…Œì´ë¸” ë¡œë“œ
        function loadEducationTable() {
            const tbody = document.getElementById('educationTableBody');
            tbody.innerHTML = educationContents.map(edu => `
                <tr>
                    <td><strong>${edu.title}</strong></td>
                    <td><span class="badge badge-info">${edu.category}</span></td>
                    <td>${edu.content_type === 'video' ? 'ğŸ“¹ ë™ì˜ìƒ' : 'ğŸ“„ ë¬¸ì„œ'}</td>
                    <td>${edu.is_mandatory ? '<span class="badge badge-danger">í•„ìˆ˜</span>' : '<span class="badge badge-secondary">ì¼ë°˜</span>'}</td>
                    <td>${getStatusBadge(edu.status)}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-secondary" onclick="openEduModal(${edu.id})">âœï¸ ìˆ˜ì •</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteEducation(${edu.id})">ğŸ—‘ï¸ ì‚­ì œ</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // êµìœ¡ ëª¨ë‹¬ ì—´ê¸°
        function openEduModal(eduId = null) {
            editingEduId = eduId;
            const title = document.getElementById('eduModalTitle');
            const form = document.getElementById('eduForm');

            if (eduId) {
                const edu = educationContents.find(e => e.id === eduId);
                if (!edu) return;
                title.textContent = 'êµìœ¡ìë£Œ ìˆ˜ì •';
                document.getElementById('eduTitleInput').value = edu.title;
                document.getElementById('eduDescriptionInput').value = edu.description || '';
                document.getElementById('eduCategoryInput').value = edu.category;
                document.getElementById('eduTypeInput').value = edu.content_type;
                document.getElementById('eduDurationInput').value = edu.duration_minutes;
                document.getElementById('eduUrlInput').value = edu.content_url;
                document.getElementById('eduMandatoryInput').checked = edu.is_mandatory;
                document.getElementById('eduActiveInput').checked = edu.status === 'active';
            } else {
                title.textContent = 'êµìœ¡ìë£Œ ì¶”ê°€';
                form.reset();
                document.getElementById('eduDurationInput').value = 60;
                document.getElementById('eduActiveInput').checked = true;
            }

            document.getElementById('eduModal').classList.remove('hidden');
        }

        function closeEduModal() {
            document.getElementById('eduModal').classList.add('hidden');
            editingEduId = null;
        }

        function saveEducationContent() {
            const title = document.getElementById('eduTitleInput').value;
            const description = document.getElementById('eduDescriptionInput').value;
            const category = document.getElementById('eduCategoryInput').value;
            const contentType = document.getElementById('eduTypeInput').value;
            const duration = parseInt(document.getElementById('eduDurationInput').value);
            const url = document.getElementById('eduUrlInput').value;
            const isMandatory = document.getElementById('eduMandatoryInput').checked;
            const isActive = document.getElementById('eduActiveInput').checked;

            if (!title || !category || !url) {
                alert('í•„ìˆ˜ í•­ëª©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            if (editingEduId) {
                const index = educationContents.findIndex(e => e.id === editingEduId);
                if (index !== -1) {
                    educationContents[index] = {
                        ...educationContents[index],
                        title, description, category, content_type: contentType,
                        duration_minutes: duration, content_url: url,
                        is_mandatory: isMandatory, status: isActive ? 'active' : 'inactive'
                    };
                }
            } else {
                const newId = educationContents.length > 0 ? Math.max(...educationContents.map(e => e.id)) + 1 : 1;
                educationContents.push({
                    id: newId,
                    title, description, category, content_type: contentType,
                    duration_minutes: duration, content_url: url,
                    is_mandatory: isMandatory, status: isActive ? 'active' : 'inactive'
                });
            }

            localStorage.setItem('kema_education_contents', JSON.stringify(educationContents));
            closeEduModal();
            loadEducationTable();
            updateEduSummary();
            loadOrganizations(); // ë°œì†¡ ì„¤ì • ëª©ë¡ ê°±ì‹ ì„ ìœ„í•´
        }

        function deleteEducation(id) {
            if (!confirm('êµìœ¡ìë£Œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ êµìœ¡ì„ ì‚¬ìš© ì¤‘ì¸ ë°œì†¡ ì„¤ì •ì— ì˜í–¥ì„ ì¤„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.')) return;
            educationContents = educationContents.filter(e => e.id !== id);
            localStorage.setItem('kema_education_contents', JSON.stringify(educationContents));
            loadEducationTable();
            updateEduSummary();
            loadOrganizations();
        }

        /* =========================================
           ë°±ì—”ë“œ ìŠ¤ì¼€ì¤„ëŸ¬ ì‹œë®¬ë ˆì´ì…˜ ë¡œì§
           ========================================= */
        let schedulerInterval = null;
        let isSchedulerRunning = false;

        // ë¡œê·¸ ì¶œë ¥ í•¨ìˆ˜
        function addSystemLog(message, type = 'info') {
            const logs = document.getElementById('systemLogs');
            const entry = document.createElement('div');
            const time = new Date().toLocaleTimeString('ko-KR');

            let color = '#d4d4d4'; // ê¸°ë³¸ (info)
            if (type === 'success') color = '#4ade80'; // ë…¹ìƒ‰
            if (type === 'warning') color = '#fbbf24'; // ë…¸ë€ìƒ‰
            if (type === 'error') color = '#f87171';   // ë¹¨ê°„ìƒ‰

            entry.style.color = color;
            entry.style.marginBottom = '4px';
            entry.innerText = `[${time}] ${message}`;

            logs.appendChild(entry);
            logs.scrollTop = logs.scrollHeight; // ìë™ ìŠ¤í¬ë¡¤
        }

        function clearSystemLogs() {
            document.getElementById('systemLogs').innerHTML = '';
            addSystemLog('ë¡œê·¸ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        // ìŠ¤ì¼€ì¤„ëŸ¬ ì‹œì‘/ì¤‘ì§€ í† ê¸€
        function toggleScheduler() {
            const statusBadge = document.getElementById('schedulerStatus');
            const btn = document.getElementById('btnStartScheduler');

            if (isSchedulerRunning) {
                // ì¤‘ì§€ ë¡œì§
                clearInterval(schedulerInterval);
                isSchedulerRunning = false;
                statusBadge.textContent = 'ì¤‘ì§€ë¨';
                statusBadge.className = 'badge badge-warning';
                btn.textContent = 'â–¶ ì‹œìŠ¤í…œ ê°€ë™';
                btn.classList.replace('btn-danger', 'btn-primary');
                addSystemLog('ìŠ¤ì¼€ì¤„ëŸ¬ê°€ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.', 'warning');
            } else {
                // ì‹œì‘ ë¡œì§
                isSchedulerRunning = true;
                statusBadge.textContent = 'ê°€ë™ ì¤‘';
                statusBadge.className = 'badge badge-success';
                btn.textContent = 'â–  ì‹œìŠ¤í…œ ì¤‘ì§€';
                btn.classList.replace('btn-primary', 'btn-danger');

                addSystemLog('ìŠ¤ì¼€ì¤„ëŸ¬ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤. (ì£¼ê¸°: 10ì´ˆ)', 'success');

                // ì¦‰ì‹œ í•œ ë²ˆ ì‹¤í–‰
                checkScheduleAndSend();

                // 10ì´ˆë§ˆë‹¤ ì‹¤í–‰ (í…ŒìŠ¤íŠ¸ìš©)
                schedulerInterval = setInterval(checkScheduleAndSend, 10000);
            }
        }

        // í•µì‹¬ ìŠ¤ì¼€ì¤„ëŸ¬ ë¡œì§ (Backend Logic)
        function checkScheduleAndSend() {
            const days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
            const now = new Date();
            const currentDay = days[now.getDay()];
            const currentTime = now.toTimeString().substring(0, 5); // "14:30" í˜•ì‹

            addSystemLog(`ìŠ¤ì¼€ì¤„ í™•ì¸ ì¤‘... (${currentDay}ìš”ì¼ ${currentTime})`);

            // 1. í™œì„±í™”ëœ ì„¤ì • í•„í„°ë§
            // ì‹¤ì œ í™˜ê²½ì—ì„œëŠ” DB ì¿¼ë¦¬ë¡œ ìˆ˜í–‰ë¨: SELECT * FROM notification_settings WHERE is_active = true
            const activeSettings = mockNotificationSettings.filter(s => s.is_active);

            let matchedCount = 0;

            activeSettings.forEach(setting => {
                // 2. ìš”ì¼ ë§¤ì¹­ í™•ì¸
                if (!setting.send_days.includes(currentDay)) return;

                // 3. ì‹œê°„ ë§¤ì¹­ í™•ì¸
                // í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ ì‹œê°„ì²´í¬ë¥¼ ìƒëµí•˜ê³  ì‹¶ë‹¤ë©´ ì•„ë˜ ì¤„ì„ ì£¼ì„ ì²˜ë¦¬í•˜ê±°ë‚˜, 
                // í˜„ì¬ ì‹œê°„ì´ ì„¤ì •ëœ ì‹œê°„ê³¼ 'ë¹„ìŠ·í•˜ë©´' ë³´ë‚´ëŠ” ì‹ìœ¼ë¡œ ë¡œì§ ìˆ˜ì • ê°€ëŠ¥
                // ì—¬ê¸°ì„œëŠ” ì‹œë®¬ë ˆì´ì…˜ì˜ í¸ì˜ë¥¼ ìœ„í•´ 'ì‹œê°„'ê¹Œì§€ ì •í™•íˆ ë§ì•„ì•¼ í•œë‹¤ê³  ê°€ì •í•˜ë˜,
                // í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ ê°•ì œë¡œ ë§¤ì¹­ë˜ëŠ” ì„¤ì •ì„ í•˜ë‚˜ ì¶”ê°€í•˜ëŠ” ê²ƒì´ ì¢‹ìŒ.

                const settingTime = setting.send_time.substring(0, 5);

                // *** í…ŒìŠ¤íŠ¸ìš© ë¡œì§: ë§Œì•½ ì„¤ì •ëœ ì‹œê°„ì´ í˜„ì¬ ì‹œê°„ê³¼ ê°™ë‹¤ë©´ ë°œì†¡ ***
                // ì‹¤ì œë¡œëŠ” ë¶„ ë‹¨ìœ„ cron jobì´ë¯€ë¡œ ì •í™•íˆ ì¼ì¹˜í•  ë•Œë§Œ ë³´ëƒ„

                if (settingTime === currentTime) {
                    matchedCount++;
                    triggerNotification(setting);
                }
            });

            if (matchedCount === 0) {
                // ë§¤ì¹­ë˜ëŠ”ê²Œ ì—†ìœ¼ë©´ ì•„ë¬´ê²ƒë„ ì•ˆ í•¨ (ë¡œê·¸ê°€ ë„ˆë¬´ ì‹œë„ëŸ¬ìš¸ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ìƒëµ)
                // addSystemLog('ë°œì†¡ ëŒ€ìƒ ì—†ìŒ.');
            }
        }

        // ì•Œë¦¼í†¡ ë°œì†¡ íŠ¸ë¦¬ê±° (Backend Logic Simulation)
        function triggerNotification(setting) {
            const org = organizations.find(o => o.id === setting.organization_id);
            if (!org) return;

            addSystemLog(`âœ… [MATCH] ë°œì†¡ ì¡°ê±´ ì¼ì¹˜! ê¸°ê´€ëª…: ${org.name}`, 'success');

            // 4. ëŒ€ìƒ ìš”ì–‘ë³´í˜¸ì‚¬ ì¡°íšŒ
            const targetCaregivers = mockCaregivers.filter(c =>
                c.organization_id === org.id && c.status === 'active'
            );

            addSystemLog(`   - ëŒ€ìƒ ìš”ì–‘ë³´í˜¸ì‚¬ ìˆ˜: ${targetCaregivers.length}ëª…`);

            if (targetCaregivers.length > 0) {
                // êµìœ¡ ì •ë³´ ì¡°íšŒ
                const education = mockEducationContents.find(e => e.id === setting.education_content_id);
                const educationTitle = education ? education.title : 'ê¸°ë³¸ êµìœ¡';
                const educationId = education ? education.id : 1;

                let successCount = 0;
                let failCount = 0;
                let skipCount = 0;

                // ê° ë³´í˜¸ì‚¬ë³„ë¡œ ê°œë³„ ë©”ì‹œì§€ ìƒì„± ë° ë°œì†¡ ì‹œë®¬ë ˆì´ì…˜
                targetCaregivers.forEach(caregiver => {
                    // 1. ì¤‘ë³µ ë°œì†¡ ë°©ì§€ (ì´ë²ˆ ë‹¬ ì´ìˆ˜ ì—¬ë¶€ ì²´í¬)
                    if (isCompletedThisMonth(caregiver.id, educationId)) {
                        addSystemLog(`   â­ï¸ [SKIP] ${caregiver.name} - ì´ë¯¸ ì´ë²ˆ ë‹¬ êµìœ¡(${educationTitle})ì„ ì´ìˆ˜í–ˆìŠµë‹ˆë‹¤.`, 'warning');
                        skipCount++;
                        return; // ë°œì†¡ ê±´ë„ˆë›°ê¸°
                    }

                    // 2. ë°œì†¡ ì‹¤íŒ¨ ì‹œë®¬ë ˆì´ì…˜ (ëœë¤ 10% í™•ë¥ ë¡œ ì‹¤íŒ¨ ë°œìƒ)
                    // í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ Math.random() < 0.1 ì‚¬ìš©
                    const isFailure = Math.random() < 0.1;

                    if (isFailure) {
                        addSystemLog(`   âŒ [ì‹¤íŒ¨] ${caregiver.name} (${caregiver.phone}) - ì „í™”ë²ˆí˜¸ í˜•ì‹ ì˜¤ë¥˜`, 'error');
                        saveNotificationLog(caregiver.id, org.id, educationId, 'failed', 'ì „í™”ë²ˆí˜¸ í˜•ì‹ ì˜¤ë¥˜');
                        failCount++;
                        return;
                    }

                    // ê³ ìœ  êµìœ¡ URL ìƒì„± (UUID ì‹œë®¬ë ˆì´ì…˜)
                    const uniqueId = `edu_${educationId}_${caregiver.id}_${Date.now().toString(36)}`;
                    const educationUrl = `https://kema.link/v/${uniqueId}`;

                    // ë©”ì‹œì§€ í…œí”Œë¦¿ ì¹˜í™˜
                    let messageBody = setting.message_template || getDefaultMessageTemplate();
                    messageBody = messageBody
                        .replace(/{ê¸°ê´€ëª…}/g, org.name)
                        .replace(/{ë³´í˜¸ì‚¬ëª…}/g, caregiver.name)
                        .replace(/{êµìœ¡ëª…}/g, educationTitle)
                        .replace(/{ë°œì†¡ì¼ì‹œ}/g, new Date().toLocaleString('ko-KR'));

                    // API Payload (Log Only)
                    const apiPayload = {
                        receiver_phone: caregiver.phone,
                        message: messageBody,
                        url: educationUrl
                    };

                    addSystemLog(`   ğŸš€ [ë°œì†¡ ì™„ë£Œ] ${caregiver.name} (${caregiver.phone})`, 'info');
                    // addSystemLog(`      ğŸ”— ë²„íŠ¼ ë§í¬: ${educationUrl}`, 'info'); 

                    // ì„±ê³µ ë¡œê·¸ ì €ì¥
                    saveNotificationLog(caregiver.id, org.id, educationId, 'sent', null);
                    successCount++;
                });

                addSystemLog(`   âœ¨ ì²˜ë¦¬ ê²°ê³¼: ì„±ê³µ ${successCount}ê±´, ì‹¤íŒ¨ ${failCount}ê±´, ìŠ¤í‚µ(ì´ìˆ˜ì™„ë£Œ) ${skipCount}ê±´`, 'success');

            } else {
                addSystemLog(`   âš ï¸ ì£¼ì˜: ë°œì†¡ ëŒ€ìƒ ìš”ì–‘ë³´í˜¸ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤.`, 'warning');
            }
        }

        // í—¬í¼ í•¨ìˆ˜: ì´ë²ˆ ë‹¬ êµìœ¡ ì´ìˆ˜ ì—¬ë¶€ í™•ì¸
        function isCompletedThisMonth(caregiverId, educationContentId) {
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth(); // 0-indexed

            return mockCompletionRecords.some(record => {
                if (record.caregiver_id !== caregiverId ||
                    record.education_content_id !== educationContentId ||
                    record.status !== 'completed') {
                    return false;
                }

                // ì‹¤ì œ ë°ì´í„°ì˜ completed_at ë¬¸ìì—´ì„ íŒŒì‹±
                const completedDate = new Date(record.completed_at);
                return completedDate.getFullYear() === currentYear &&
                    completedDate.getMonth() === currentMonth;
            });
        }

        // í—¬í¼ í•¨ìˆ˜: ë°œì†¡ ë¡œê·¸ ì €ì¥ (localStorage í™œìš© - ì„¼í„°ì¥ ëŒ€ì‹œë³´ë“œ ê³µìœ ìš©)
        function saveNotificationLog(caregiverId, orgId, contentId, status, errorMessage) {
            const logs = JSON.parse(localStorage.getItem('kema_notification_logs') || '[]');

            logs.unshift({
                id: Date.now() + Math.random(),
                caregiver_id: caregiverId,
                organization_id: orgId,
                education_content_id: contentId,
                status: status, // 'sent' or 'failed'
                error_message: errorMessage,
                sent_at: new Date().toISOString()
            });

            // ìµœëŒ€ 100ê°œê¹Œì§€ë§Œ ì €ì¥ (ë°ëª¨ìš©)
            if (logs.length > 100) logs.pop();

            localStorage.setItem('kema_notification_logs', JSON.stringify(logs));
        }
    </script>
</body>

</html>