<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>êµìœ¡ ì´ìˆ˜ - ì¼€ë§ˆ</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* ëª¨ë°”ì¼ ì „ìš© ì¶”ê°€ ìŠ¤íƒ€ì¼ */
        body {
            background-color: #f5f5f5;
            padding-bottom: 40px;
        }

        .viewer-container {
            max-width: 480px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* 16:9 ë°˜ì‘í˜• ë¹„ë””ì˜¤ */
        .video-wrapper {
            position: relative;
            padding-bottom: 56.25%;
            height: 0;
            background: black;
        }

        .video-wrapper iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .content-body {
            padding: 20px;
            flex: 1;
            opacity: 0;
            animation: fadeIn 0.5s forwards;
        }

        .quiz-card {
            background: white;
            border: 1px solid var(--neutral-200);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-sm);
        }

        .quiz-question {
            font-weight: 600;
            font-size: 1.05rem;
            margin-bottom: 12px;
            color: var(--neutral-900);
        }

        .option-btn {
            width: 100%;
            text-align: left;
            padding: 12px 16px;
            margin-bottom: 8px;
            border: 1px solid var(--neutral-300);
            border-radius: 8px;
            background: white;
            font-size: 0.95rem;
            transition: all 0.2s;
            cursor: pointer;
        }

        .option-btn:hover {
            background-color: var(--neutral-50);
        }

        .option-btn.selected {
            border-color: var(--primary-500);
            background-color: var(--primary-50);
            color: var(--primary-700);
            font-weight: 600;
        }

        .btn-full {
            width: 100%;
            padding: 16px;
            font-size: 1.1rem;
            font-weight: bold;
            border-radius: 12px;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body>
    <div class="viewer-container">
        <!-- í—¤ë” -->
        <header
            style="padding: 16px; border-bottom: 1px solid #eee; display:flex; align-items:center; justify-content:space-between; background:white; z-index:10;">
            <h1 style="font-size: 1.1rem; margin: 0; font-weight:700; color:var(--primary-600);">ğŸ“š ì¼€ë§ˆ êµìœ¡ì„¼í„°</h1>
            <span class="badge badge-info" id="caregiverName">ë¡œë”© ì¤‘...</span>
        </header>

        <!-- ë¹„ë””ì˜¤ ì˜ì—­ -->
        <div class="video-section">
            <div class="video-wrapper">
                <!-- ìœ íŠœë¸Œ APIë¡œ ëŒ€ì²´ë  DIV -->
                <div id="player"></div>
            </div>
            <div style="padding: 20px; background: white; border-bottom: 1px solid #f1f5f9;">
                <span class="badge badge-primary" style="margin-bottom:8px;">í•„ìˆ˜ êµìœ¡</span>
                <h2 id="videoTitle" style="font-size: 1.25rem; margin: 0 0 8px 0; line-height:1.4;">êµìœ¡ ì œëª© ë¡œë”© ì¤‘...</h2>
                <div id="progressMsg"
                    style="font-size: 0.9rem; color: var(--neutral-500); display:flex; align-items:center; gap:6px;">
                    <span
                        style="display:inline-block; width:8px; height:8px; border-radius:50%; background:orange;"></span>
                    ì˜ìƒì„ ì‹œì²­ ì¤‘ì…ë‹ˆë‹¤...
                </div>
            </div>
        </div>

        <!-- í€´ì¦ˆ ì˜ì—­ (ì´ˆê¸° ìˆ¨ê¹€) -->
        <div id="quizSection" class="content-body" style="display: none;">
            <div style="margin-bottom:20px;">
                <h3 style="margin:0 0 8px 0; font-size:1.15rem;">âœ… ì´ìˆ˜ í™•ì¸ í‰ê°€</h3>
                <p style="color: var(--neutral-600); margin:0; font-size:0.95rem;">
                    ì˜ìƒì„ ëª¨ë‘ ì‹œì²­í•˜ì…¨êµ°ìš”! ì•„ë˜ ë¬¸ì œë¥¼ í’€ì–´ì£¼ì„¸ìš”.<br>
                    (ì´ <span id="totalQuestions">0</span>ë¬¸ì œ / <span style="color:#ef4444; font-weight:600;">80ì </span>
                    ì´ìƒ ì´ìˆ˜ ì™„ë£Œ)
                </p>
            </div>

            <div id="questionContainer">
                <!-- ë™ì  í€´ì¦ˆ ìƒì„± -->
            </div>

            <button class="btn btn-primary btn-full shadow-lg" id="btnSubmitQuiz" onclick="submitQuiz()">
                ì œì¶œí•˜ê³  ê²°ê³¼ í™•ì¸
            </button>
        </div>

        <!-- í‘¸í„° (ì—¬ë°±ìš©) -->
        <div style="height: 40px;"></div>
    </div>

    <!-- ê²°ê³¼ ëª¨ë‹¬ -->
    <div id="resultModal" class="modal-overlay hidden">
        <div class="modal" style="text-align: center; padding: 40px 24px; max-width: 340px; border-radius:20px;">
            <div id="resultIcon" style="font-size: 4rem; margin-bottom: 20px;">ğŸ‰</div>
            <h3 id="resultTitle" style="font-size: 1.6rem; margin-bottom: 12px; font-weight:800;">ì´ìˆ˜ ì™„ë£Œ!</h3>
            <p id="resultMsg" style="color: var(--neutral-600); margin-bottom: 24px; line-height:1.5;">ì¶•í•˜í•©ë‹ˆë‹¤.<br>ëª¨ë“  êµìœ¡
                ê³¼ì •ì„ ì„±ê³µì ìœ¼ë¡œ ë§ˆì³¤ìŠµë‹ˆë‹¤.</p>

            <div style="background: #f8fafc; padding: 20px; border-radius: 16px; margin-bottom: 24px;">
                <span style="font-size: 0.9rem; color: var(--neutral-500);">ìµœì¢… ì ìˆ˜</span>
                <div id="resultScore" style="font-size: 2.5rem; font-weight: 800; color: var(--primary-600);">100ì </div>
            </div>

            <button class="btn btn-primary btn-full" onclick="window.close()" style="border-radius:12px;">ì°½ ë‹«ê¸°</button>
        </div>
    </div>

    <script src="mockData.js"></script>
    <script>
        // 1. íŒŒë¼ë¯¸í„° íŒŒì‹± (ì‹œë®¬ë ˆì´ì…˜: ?id=1&content=1 or token=edu_1_1_xxx)
        const params = new URLSearchParams(window.location.search);
        let caregiverId = 1; // Default for test
        let contentId = 1;   // Default for test

        // í† í° íŒŒì‹± ë¡œì§ (ì˜ˆ: token=edu_1_5_xxxx)
        const token = params.get('token') || params.get('t');
        if (token) {
            try {
                const parts = token.split('_'); // ['edu', 'contentId', 'caregiverId', 'uuid']
                if (parts.length >= 3) {
                    contentId = parseInt(parts[1]);
                    caregiverId = parseInt(parts[2]);
                }
            } catch (e) { console.error("Token parsing error", e); }
        }

        // Mock Data ë¡œë“œ í™•ì¸
        if (typeof mockCaregivers === 'undefined') {
            alert('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.');
        }

        // 2. ì´ˆê¸° ë°ì´í„° ì„¸íŒ…
        const caregiver = mockCaregivers.find(c => c.id === caregiverId);
        const content = mockEducationContents.find(e => e.id === contentId);

        document.getElementById('caregiverName').textContent = caregiver ? caregiver.name + 'ë‹˜' : 'ê²ŒìŠ¤íŠ¸';
        document.getElementById('videoTitle').textContent = content ? content.title : 'êµìœ¡ ì˜ìƒ';

        // 3. YouTube Player API ë¡œë“œ
        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        var player;
        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '100%',
                width: '100%',
                videoId: 'M7lc1UVf-VE', // ì˜ˆì‹œ ì˜ìƒ (Google Developers) - ì‹¤ì œë¡œëŠ” content.video_id ì‚¬ìš©
                playerVars: {
                    'playsinline': 1,
                    'rel': 0,
                    'modestbranding': 1
                },
                events: {
                    'onStateChange': onPlayerStateChange
                }
            });
        }

        // 4. ì˜ìƒ ìƒíƒœ ë³€ê²½ ê°ì§€
        let isVideoCompleted = false;
        function onPlayerStateChange(event) {
            if (event.data === YT.PlayerState.ENDED) {
                isVideoCompleted = true;
                showQuizSection();
            } else if (event.data === YT.PlayerState.PLAYING) {
                document.getElementById('progressMsg').innerHTML =
                    `<span style="display:inline-block; width:8px; height:8px; border-radius:50%; background:#10B981; margin-right:6px;"></span>ì‹œì²­ ì¤‘... ëê¹Œì§€ ë´ì£¼ì„¸ìš”!`;
            }
        }

        // 5. í€´ì¦ˆ ì„¹ì…˜ í‘œì‹œ
        function showQuizSection() {
            document.getElementById('progressMsg').innerHTML =
                `<span style="color:#10B981; font-weight:bold;">âœ… ì‹œì²­ ì™„ë£Œ! ì•„ë˜ í€´ì¦ˆë¥¼ í’€ì–´ì£¼ì„¸ìš”.</span>`;

            const quizSection = document.getElementById('quizSection');
            quizSection.style.display = 'block';

            // í€´ì¦ˆ ë Œë”ë§
            renderQuiz();

            // ìì—°ìŠ¤ëŸ½ê²Œ ìŠ¤í¬ë¡¤
            setTimeout(() => {
                quizSection.scrollIntoView({ behavior: 'smooth' });
            }, 500);
        }

        // 6. í€´ì¦ˆ ë Œë”ë§ ë° ë¡œì§
        let currentAnswers = {}; // { questionId: selectedIndex }

        function renderQuiz() {
            // mockQuizzesëŠ” mockData.jsì— ì •ì˜ë˜ì–´ì•¼ í•¨
            if (typeof mockQuizzes === 'undefined') {
                document.getElementById('questionContainer').innerHTML = '<p>í€´ì¦ˆ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            const quizData = mockQuizzes.find(q => q.education_content_id === contentId);
            if (!quizData) {
                document.getElementById('questionContainer').innerHTML = '<p>ì´ êµìœ¡ì— ë“±ë¡ëœ í€´ì¦ˆê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            const questions = quizData.questions;
            document.getElementById('totalQuestions').textContent = questions.length;

            const container = document.getElementById('questionContainer');
            container.innerHTML = questions.map((q, idx) => `
                <div class="quiz-card" id="q_${q.id}">
                    <div class="quiz-question">${idx + 1}. ${q.question}</div>
                    <div class="options">
                        ${q.options.map((opt, i) => `
                            <button class="option-btn" onclick="selectOption(${q.id}, ${i})">${opt}</button>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        window.selectOption = function (questionId, optionIndex) {
            currentAnswers[questionId] = optionIndex;

            // UI ì—…ë°ì´íŠ¸
            const card = document.getElementById(`q_${questionId}`);
            const buttons = card.querySelectorAll('.option-btn');
            buttons.forEach((btn, idx) => {
                if (idx === optionIndex) btn.classList.add('selected');
                else btn.classList.remove('selected');
            });
        };

        window.submitQuiz = function () {
            const quizData = mockQuizzes.find(q => q.education_content_id === contentId);
            if (!quizData) return;

            const questions = quizData.questions;

            // ëª¨ë“  ë¬¸ì œ í’€ì—ˆëŠ”ì§€ í™•ì¸
            if (Object.keys(currentAnswers).length < questions.length) {
                alert('ëª¨ë“  ë¬¸ì œë¥¼ í’€ì–´ì£¼ì„¸ìš”!');
                return;
            }

            // ì±„ì 
            let correctCount = 0;
            questions.forEach(q => {
                if (currentAnswers[q.id] === q.answer) correctCount++;
            });

            const score = Math.round((correctCount / questions.length) * 100);
            const isPassed = score >= 80;

            showResult(score, isPassed);
        };

        function showResult(score, isPassed) {
            const modal = document.getElementById('resultModal');
            const icon = document.getElementById('resultIcon');
            const title = document.getElementById('resultTitle');
            const msg = document.getElementById('resultMsg');
            const scoreDisplay = document.getElementById('resultScore');

            scoreDisplay.textContent = score + 'ì ';
            scoreDisplay.style.color = isPassed ? 'var(--primary-600)' : 'var(--danger-500)';

            if (isPassed) {
                icon.textContent = 'ğŸ‰';
                title.textContent = 'ì´ìˆ˜ ì™„ë£Œ!';
                msg.innerHTML = 'ì¶•í•˜í•©ë‹ˆë‹¤.<br>ëª¨ë“  êµìœ¡ ê³¼ì •ì„ ì„±ê³µì ìœ¼ë¡œ ë§ˆì³¤ìŠµë‹ˆë‹¤.';
                saveCompletionRecord(score);
            } else {
                icon.textContent = 'ğŸ˜¢';
                title.textContent = 'ì•„ì‰¬ì›Œìš”...';
                msg.innerHTML = 'ì´ìˆ˜ ê¸°ì¤€ ì ìˆ˜(80ì )ì— ë„ë‹¬í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.<br>ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
            }

            modal.classList.remove('hidden');
        }

        // 7. ê²°ê³¼ ì €ì¥ (localStorage ì—°ë™ -> ì„¼í„°ì¥ í˜ì´ì§€ì— ë°˜ì˜)
        function saveCompletionRecord(score) {
            // ì‹¤ì œë¼ë©´ API í˜¸ì¶œ
            // ì—¬ê¸°ì„œëŠ” localStorageì— ì €ì¥í•˜ì—¬ ë‹¤ë¥¸ í˜ì´ì§€ì™€ ì—°ë™

            const newRecord = {
                id: Date.now(),
                caregiver_id: caregiverId,
                education_content_id: contentId,
                status: 'completed',
                score: score,
                completed_at: new Date().toISOString()
            };

            // ê¸°ì¡´ ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ê¸°ë¡ ê°€ì ¸ì˜¤ê¸°
            const records = JSON.parse(localStorage.getItem('kema_completion_records') || '[]');

            // ì¤‘ë³µ ì œê±° (ê°™ì€ êµìœ¡ì´ë©´ ë®ì–´ì“°ê¸° or ì¶”ê°€?) -> ì—¬ê¸°ì„œëŠ” ê°€ì¥ ìµœê·¼ ê¸°ë¡ìœ¼ë¡œ ì¶”ê°€
            records.push(newRecord);

            localStorage.setItem('kema_completion_records', JSON.stringify(records));

            console.log('ì´ìˆ˜ ê¸°ë¡ ì €ì¥ ì™„ë£Œ:', newRecord);
        }
    </script>
</body>

</html>