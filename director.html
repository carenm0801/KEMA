<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì¼€ë§ˆ KEMA - ì„¼í„°ì¥ ê´€ë¦¬ì</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
</head>

<body>
  <div class="container">
    <!-- í—¤ë” -->
    <header class="header">
      <h1>ğŸ¥ ì¼€ë§ˆ KEMA</h1>
      <p id="headerSubtitle">ì„¼í„°ì¥ ê´€ë¦¬ì - ìš”ì–‘ë³´í˜¸ì‚¬ ê´€ë¦¬</p>
    </header>

    <!-- ìš”ì•½ ì¹´ë“œ -->
    <div class="summary-cards">
      <div class="summary-card">
        <div class="summary-card-icon">ğŸ‘¥</div>
        <div class="summary-card-value" id="totalCaregivers">0</div>
        <div class="summary-card-label">ì „ì²´ ë³´í˜¸ì‚¬</div>
      </div>
      <div class="summary-card">
        <div class="summary-card-icon">âœ…</div>
        <div class="summary-card-value" id="completedCaregivers">0</div>
        <div class="summary-card-label">ì´ìˆ˜ ì™„ë£Œ ì¸ì›</div>
      </div>
    </div>

    <!-- ë³´í˜¸ì‚¬ ê´€ë¦¬ í…Œì´ë¸” -->
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">ë³´í˜¸ì‚¬ ê´€ë¦¬</h2>
        <div class="action-buttons">
          <button class="btn btn-secondary" onclick="openLogModal()">
            ğŸ“‹ ì•Œë¦¼ ë°œì†¡ ì´ë ¥
          </button>
          <button class="btn btn-secondary" onclick="downloadExcelTemplate()">
            ğŸ“„ ì—‘ì…€ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ
          </button>
          <button class="btn btn-info" onclick="triggerExcelUpload()">
            ğŸ“¤ ì—‘ì…€ ì¼ê´„ ë“±ë¡
          </button>
          <input type="file" id="excelInput" accept=".csv" style="display: none;" onchange="handleExcelUpload(event)">
          <button class="btn btn-primary" onclick="openAddModal()">
            â• ë³´í˜¸ì‚¬ ì¶”ê°€
          </button>
        </div>
      </div>
      <div class="card-body">
        <div class="table-container">
          <table class="table">
            <thead>
              <tr>
                <th>ì´ë¦„</th>
                <th>ì—°ë½ì²˜</th>
                <th>ìƒë…„ì›”ì¼</th>
                <th>ìê²©ì¦ ë²ˆí˜¸</th>
                <th>ì…ì‚¬ì¼</th>
                <th>ìƒíƒœ</th>
                <th>ì´ìˆ˜ ì—¬ë¶€</th>
                <th>ì‘ì—…</th>
              </tr>
            </thead>
            <tbody id="caregiversTableBody">
              <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- ë³´í˜¸ì‚¬ ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ -->
  <div id="caregiverModal" class="modal-overlay hidden">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="modalTitle">ë³´í˜¸ì‚¬ ì¶”ê°€</h3>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      <div class="modal-body">
        <form id="caregiverForm" class="form-grid">
          <div class="form-group">
            <label class="form-label required" for="name">ì´ë¦„</label>
            <input type="text" id="name" class="form-input" placeholder="ì˜ˆ: ê¹€ì˜í¬" required>
          </div>
          <div class="form-group">
            <label class="form-label required" for="phone">ì—°ë½ì²˜</label>
            <input type="tel" id="phone" class="form-input" placeholder="010-1234-5678" required>
          </div>
          <div class="form-group">
            <label class="form-label" for="birthDate">ìƒë…„ì›”ì¼</label>
            <input type="date" id="birthDate" class="form-input">
          </div>
          <div class="form-group">
            <label class="form-label" for="certificateNumber">ìê²©ì¦ ë²ˆí˜¸</label>
            <input type="text" id="certificateNumber" class="form-input" placeholder="CG-2020-12345">
          </div>
          <div class="form-group">
            <label class="form-label" for="hireDate">ì…ì‚¬ì¼</label>
            <input type="date" id="hireDate" class="form-input">
          </div>
          <div class="form-group">
            <label class="form-label required" for="status">ìƒíƒœ</label>
            <select id="status" class="form-select" required>
              <option value="active">ì¬ì§ ì¤‘</option>
              <option value="inactive">íœ´ì§</option>
              <option value="resigned">í‡´ì‚¬</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
        <button class="btn btn-primary" onclick="saveCaregiver()">ì €ì¥</button>
      </div>
    </div>
  </div>

  <!-- ì•Œë¦¼ ë°œì†¡ ì´ë ¥ ëª¨ë‹¬ -->
  <div id="logModal" class="modal-overlay hidden">
    <div class="modal" style="max-width: 800px;">
      <div class="modal-header">
        <h3 class="modal-title">ğŸ“‹ ì•Œë¦¼í†¡ ë°œì†¡ ì´ë ¥</h3>
        <button class="modal-close" onclick="closeLogModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="table-container" style="max-height: 500px; overflow-y: auto;">
          <table class="table">
            <thead>
              <tr>
                <th>ë°œì†¡ ì¼ì‹œ</th>
                <th>ë³´í˜¸ì‚¬ëª…</th>
                <th>êµìœ¡ëª…</th>
                <th>ìƒíƒœ</th>
                <th>ë¹„ê³ </th>
              </tr>
            </thead>
            <tbody id="logTableBody">
              <!-- ë¡œê·¸ ë°ì´í„° í‘œì‹œ -->
            </tbody>
          </table>
          <div id="noLogsMessage" style="text-align: center; padding: 20px; color: #666; display: none;">
            ë°œì†¡ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" onclick="closeLogModal()">í™•ì¸</button>
      </div>
    </div>
  </div>

  <!-- ë³´ê³ ì„œ ì„¹ì…˜ -->
  <div id="reportSection" class="card mt-md">
    <div class="card-header">
      <h2 class="card-title">ğŸ“Š ë³´ê³ ì„œ ë° ë°ì´í„° ê´€ë¦¬</h2>
      <div class="action-buttons no-print">
        <button class="btn btn-primary" onclick="printReport()">
          ğŸ–¨ï¸ ë³´ê³ ì„œ ì¸ì‡„
        </button>
        <button class="btn btn-success" onclick="exportToCSV()">
          ğŸ’¾ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
        </button>
      </div>
    </div>
    <div class="card-body" style="padding: 20px;">
      <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 20px;">
        <h2 style="font-size: 24px; font-weight: bold; margin-bottom: 10px;">[2026ë…„ 01ì›”] ì§ë¬´êµìœ¡ ì‹¤ì‹œ ê²°ê³¼ ë³´ê³ ì„œ</h2>
        <p style="font-size: 16px;">êµìœ¡ëª…: <strong>ê°ì—¼ ê´€ë¦¬ ê¸°ë³¸ êµìœ¡</strong> | êµìœ¡ê¸°ê°„: 2026.01.01 ~ 2026.01.31</p>
      </div>
      <table class="table" style="width: 100%; border-collapse: collapse; margin-bottom: 30px;">
        <thead>
          <tr style="background: #f8f9fa;">
            <th style="border: 1px solid #ddd; padding: 12px; text-align: center;">ê¸°ê´€ëª…</th>
            <th style="border: 1px solid #ddd; padding: 12px; text-align: center;">ë³´í˜¸ì‚¬ëª…</th>
            <th style="border: 1px solid #ddd; padding: 12px; text-align: center;">ì—°ë½ì²˜</th>
            <th style="border: 1px solid #ddd; padding: 12px; text-align: center;">ì´ìˆ˜ ìƒíƒœ</th>
            <th style="border: 1px solid #ddd; padding: 12px; text-align: center;">ì ìˆ˜</th>
            <th style="border: 1px solid #ddd; padding: 12px; text-align: center;">ì™„ë£Œ ì¼ì‹œ</th>
          </tr>
        </thead>
        <tbody id="reportTableBody">
          <!-- ë°ì´í„° ë¡œë“œ -->
        </tbody>
      </table>
      <div style="margin-top: 50px; text-align: center;">
        <h3 style="font-size: 20px; margin-bottom: 40px;">ìœ„ì™€ ê°™ì´ êµìœ¡ì„ ì‹¤ì‹œí•˜ì˜€ìŒì„ ë³´ê³ í•©ë‹ˆë‹¤.</h3>
        <p style="margin-bottom: 30px; font-size: 16px;">2026ë…„ 01ì›” 16ì¼</p>
        <div style="font-size: 24px; font-weight: bold; position: relative; display: inline-block;">
          <span id="orgSignature">ì¼€ë§ˆ ì¬ê°€ë…¸ì¸ë³µì§€ì„¼í„°ì¥ (ì¸)</span>
          <div
            style="position: absolute; right: -40px; top: -10px; width: 60px; height: 60px; border: 3px solid red; border-radius: 50%; color: red; font-size: 14px; line-height: 55px; transform: rotate(-15deg); opacity: 0.8;">
            ì§ì¸</div>
        </div>
      </div>
    </div>
  </div>

  <script src="mockData.js"></script>
  <script>
    // í˜„ì¬ ë¡œê·¸ì¸í•œ ê¸°ê´€ ID (localStorageì—ì„œ ê°€ì ¸ì˜´)
    const CURRENT_ORGANIZATION_ID = parseInt(localStorage.getItem('kema_current_org') || '1');
    const CURRENT_ORG_DATA = mockOrganizations.find(org => org.id === CURRENT_ORGANIZATION_ID) || mockOrganizations[0];

    // í˜„ì¬ í¸ì§‘ ì¤‘ì¸ ë³´í˜¸ì‚¬ ID
    let editingCaregiverId = null;
    let caregivers = []; // ë¡œì»¬ ë°ì´í„° ê´€ë¦¬

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', () => {
      initCaregivers();
      initPage();
      loadCaregivers();
      updateSummaryCards();
      loadReportData(); // ë³´ê³ ì„œ ë°ì´í„° ë¡œë“œ
    });

    // ë°ì´í„° ì´ˆê¸°í™” (Mock -> LocalStorage)
    function initCaregivers() {
      const stored = localStorage.getItem('kema_caregivers');
      if (stored) {
        caregivers = JSON.parse(stored);
      } else {
        caregivers = [...mockCaregivers];
        localStorage.setItem('kema_caregivers', JSON.stringify(caregivers));
      }
    }

    // í˜ì´ì§€ ì´ˆê¸° í…ìŠ¤íŠ¸ ì„¤ì •
    function initPage() {
      // í—¤ë” ì„œë¸Œíƒ€ì´í‹€ ì—…ë°ì´íŠ¸
      document.getElementById('headerSubtitle').textContent = `${CURRENT_ORG_DATA.name} - ìš”ì–‘ë³´í˜¸ì‚¬ ê´€ë¦¬`;
      // ë³´ê³ ì„œ í•˜ë‹¨ ì„œëª… ì—…ë°ì´íŠ¸
      document.getElementById('orgSignature').textContent = `${CURRENT_ORG_DATA.name} ì„¼í„°ì¥ (ì¸)`;
    }

    // ë³´ê³ ì„œ ë°ì´í„° ë¡œë“œ
    function loadReportData() {
      const tbody = document.getElementById('reportTableBody');
      const orgCaregivers = caregivers.filter(c => c.organization_id === CURRENT_ORGANIZATION_ID);
      const allRecords = getAllCompletionRecords();

      // ë°ì´í„° ë§¤í•‘
      const reportData = orgCaregivers.map(caregiver => {
        const record = allRecords.find(r => r.caregiver_id === caregiver.id && r.education_content_id === 1 && r.status === 'completed');
        return {
          orgName: CURRENT_ORG_DATA.name,
          name: caregiver.name,
          phone: caregiver.phone,
          status: record ? 'ì´ìˆ˜ ì™„ë£Œ' : 'ë¯¸ì´ìˆ˜',
          score: record ? '100ì ' : '-',
          completedAt: record ? new Date(record.completed_at).toLocaleDateString() : '-'
        };
      });

      tbody.innerHTML = reportData.map(d => `
            <tr>
                <td style="border: 1px solid #ddd; padding: 10px; text-align: center;">${d.orgName}</td>
                <td style="border: 1px solid #ddd; padding: 10px; text-align: center;">${d.name}</td>
                <td style="border: 1px solid #ddd; padding: 10px; text-align: center;">${d.phone}</td>
                <td style="border: 1px solid #ddd; padding: 10px; text-align: center;">${d.status}</td>
                <td style="border: 1px solid #ddd; padding: 10px; text-align: center;">${d.score}</td>
                <td style="border: 1px solid #ddd; padding: 10px; text-align: center;">${d.completedAt}</td>
            </tr>
        `).join('');
    }

    // ë³´ê³ ì„œ ì¸ì‡„
    function printReport() {
      window.print();
    }

    // ì—‘ì…€(CSV) ë‹¤ìš´ë¡œë“œ
    function exportToCSV() {
      const orgCaregivers = caregivers.filter(c => c.organization_id === CURRENT_ORGANIZATION_ID);
      const allRecords = getAllCompletionRecords();

      let csvContent = "\uFEFF"; // BOM (í•œê¸€ ê¹¨ì§ ë°©ì§€)
      csvContent += "ê¸°ê´€ëª…,ì„±ëª…,ì—°ë½ì²˜,êµìœ¡ëª…,ì´ìˆ˜ì—¬ë¶€,ì ìˆ˜,ì´ìˆ˜ì¼ì‹œ\n";

      orgCaregivers.forEach(caregiver => {
        const record = allRecords.find(r => r.caregiver_id === caregiver.id && r.education_content_id === 1 && r.status === 'completed');

        const row = [
          CURRENT_ORG_DATA.name,
          caregiver.name,
          caregiver.phone,
          'ê°ì—¼ ê´€ë¦¬ ê¸°ë³¸ êµìœ¡',
          record ? 'ì´ìˆ˜ ì™„ë£Œ' : 'ë¯¸ì´ìˆ˜',
          record ? '100' : '0',
          record ? new Date(record.completed_at).toLocaleString() : '-'
        ];
        csvContent += row.join(",") + "\n";
      });

      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement("a");
      const url = URL.createObjectURL(blob);
      link.setAttribute("href", url);
      link.setAttribute("download", `êµìœ¡ì´ìˆ˜ê²°ê³¼_${new Date().toISOString().slice(0, 10)}.csv`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // í†µí•© ì´ìˆ˜ ê¸°ë¡ ê°€ì ¸ì˜¤ê¸° (Mock + LocalStorage)
    function getAllCompletionRecords() {
      const localRecords = JSON.parse(localStorage.getItem('kema_completion_records') || '[]');
      return [...mockCompletionRecords, ...localRecords];
    }

    // ìš”ì•½ ì¹´ë“œ ì—…ë°ì´íŠ¸
    function updateSummaryCards() {
      const orgCaregivers = caregivers.filter(c => c.organization_id === CURRENT_ORGANIZATION_ID);
      const totalCount = orgCaregivers.length;

      // ì´ìˆ˜ ì™„ë£Œ ì¸ì› ê³„ì‚° (ìµœì†Œ 1ê°œ ì´ìƒì˜ êµìœ¡ì„ ì™„ë£Œí•œ ë³´í˜¸ì‚¬)
      const allRecords = getAllCompletionRecords();
      const completedCaregiverIds = new Set(
        allRecords
          .filter(r => r.status === 'completed')
          .map(r => r.caregiver_id)
      );

      const orgCompletedCount = orgCaregivers.filter(c =>
        completedCaregiverIds.has(c.id)
      ).length;

      document.getElementById('totalCaregivers').textContent = totalCount;
      document.getElementById('completedCaregivers').textContent = orgCompletedCount;
    }

    // ë³´í˜¸ì‚¬ ëª©ë¡ ë¡œë“œ
    function loadCaregivers() {
      const tbody = document.getElementById('caregiversTableBody');
      const orgCaregivers = caregivers.filter(c => c.organization_id === CURRENT_ORGANIZATION_ID);

      const allRecords = getAllCompletionRecords();
      // ê°ì—¼ ê´€ë¦¬ êµìœ¡(ID:1) ì´ìˆ˜ ì—¬ë¶€ë¥¼ í™•ì¸í•œë‹¤ê³  ê°€ì •
      const checkCompletion = (caregiverId) => {
        return allRecords.some(r =>
          r.caregiver_id === caregiverId &&
          r.education_content_id === 1 &&
          r.status === 'completed'
        );
      };

      tbody.innerHTML = orgCaregivers.map(caregiver => {
        const isCompleted = checkCompletion(caregiver.id);
        const completionBadge = isCompleted
          ? '<span class="badge badge-success">ì´ìˆ˜ ì™„ë£Œ</span>'
          : '<span class="badge badge-warning" style="background:#f3f4f6; color:#6b7280;">ë¯¸ì´ìˆ˜</span>';

        return `
        <tr>
          <td>${caregiver.name}</td>
          <td>${caregiver.phone}</td>
          <td>${caregiver.birth_date || '-'}</td>
          <td>${caregiver.certificate_number || '-'}</td>
          <td>${caregiver.hire_date || '-'}</td>
          <td>${getStatusBadge(caregiver.status)}</td>
          <td>${completionBadge}</td>
          <td>
            <div class="action-buttons">
              <button class="btn btn-sm btn-secondary" onclick="editCaregiver(${caregiver.id})">
                âœï¸ ìˆ˜ì •
              </button>
              <button class="btn btn-sm btn-danger" onclick="deleteCaregiver(${caregiver.id})">
                ğŸ—‘ï¸ ì‚­ì œ
              </button>
            </div>
          </td>
        </tr>
      `}).join('');
    }

    // ìƒíƒœ ë°°ì§€ ìƒì„±
    function getStatusBadge(status) {
      const statusMap = {
        'active': { label: 'ì¬ì§ ì¤‘', class: 'badge-success' },
        'inactive': { label: 'íœ´ì§', class: 'badge-warning' },
        'resigned': { label: 'í‡´ì‚¬', class: 'badge-danger' }
      };
      const { label, class: badgeClass } = statusMap[status] || { label: status, class: 'badge-info' };
      return `<span class="badge ${badgeClass}">${label}</span>`;
    }

    // ë³´í˜¸ì‚¬ ì¶”ê°€ ëª¨ë‹¬ ì—´ê¸°
    function openAddModal() {
      editingCaregiverId = null;
      document.getElementById('modalTitle').textContent = 'ë³´í˜¸ì‚¬ ì¶”ê°€';
      document.getElementById('caregiverForm').reset();
      document.getElementById('caregiverModal').classList.remove('hidden');
    }

    // ë³´í˜¸ì‚¬ ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸°
    function editCaregiver(id) {
      editingCaregiverId = id;
      const caregiver = caregivers.find(c => c.id === id);

      if (!caregiver) return;

      document.getElementById('modalTitle').textContent = 'ë³´í˜¸ì‚¬ ìˆ˜ì •';
      document.getElementById('name').value = caregiver.name;
      document.getElementById('phone').value = caregiver.phone;
      document.getElementById('birthDate').value = caregiver.birth_date || '';
      document.getElementById('certificateNumber').value = caregiver.certificate_number || '';
      document.getElementById('hireDate').value = caregiver.hire_date || '';
      document.getElementById('status').value = caregiver.status;

      document.getElementById('caregiverModal').classList.remove('hidden');
    }

    // ëª¨ë‹¬ ë‹«ê¸°
    function closeModal() {
      document.getElementById('caregiverModal').classList.add('hidden');
      editingCaregiverId = null;
    }

    // ë³´í˜¸ì‚¬ ì €ì¥
    function saveCaregiver() {
      const formData = {
        name: document.getElementById('name').value,
        phone: document.getElementById('phone').value,
        birth_date: document.getElementById('birthDate').value || null,
        certificate_number: document.getElementById('certificateNumber').value || null,
        hire_date: document.getElementById('hireDate').value || null,
        status: document.getElementById('status').value
      };

      // ìœ íš¨ì„± ê²€ì‚¬
      if (!formData.name || !formData.phone) {
        alert('ì´ë¦„ê³¼ ì—°ë½ì²˜ëŠ” í•„ìˆ˜ ì…ë ¥ í•­ëª©ì…ë‹ˆë‹¤.');
        return;
      }

      if (editingCaregiverId) {
        // ìˆ˜ì •
        const index = caregivers.findIndex(c => c.id === editingCaregiverId);
        if (index !== -1) {
          caregivers[index] = {
            ...caregivers[index],
            ...formData
          };
        }
      } else {
        // ì¶”ê°€
        const newId = caregivers.length > 0 ? Math.max(...caregivers.map(c => c.id)) + 1 : 1;
        caregivers.push({
          id: newId,
          organization_id: CURRENT_ORGANIZATION_ID,
          ...formData
        });
      }

      localStorage.setItem('kema_caregivers', JSON.stringify(caregivers));
      closeModal();
      loadCaregivers();
      updateSummaryCards();
      loadReportData();
    }

    // ë³´í˜¸ì‚¬ ì‚­ì œ
    function deleteCaregiver(id) {
      const caregiver = caregivers.find(c => c.id === id);
      if (!caregiver) return;

      if (confirm(`${caregiver.name} ë³´í˜¸ì‚¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        const index = caregivers.findIndex(c => c.id === id);
        if (index !== -1) {
          caregivers.splice(index, 1);
          localStorage.setItem('kema_caregivers', JSON.stringify(caregivers));
          loadCaregivers();
          updateSummaryCards();
          loadReportData();
        }
      }
    }

    // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
    document.getElementById('caregiverModal').addEventListener('click', (e) => {
      if (e.target.id === 'caregiverModal') {
        closeModal();
      }
    });

    /* =========================================
       ì•Œë¦¼í†¡ ë°œì†¡ ì´ë ¥ (ë¡œê·¸) ê¸°ëŠ¥
       ========================================= */

    function openLogModal() {
      document.getElementById('logModal').classList.remove('hidden');
      loadNotificationLogs();
    }

    function closeLogModal() {
      document.getElementById('logModal').classList.add('hidden');
    }

    function loadNotificationLogs() {
      const tbody = document.getElementById('logTableBody');
      // localStorageì—ì„œ ë¡œê·¸ ì½ì–´ì˜¤ê¸° (ë³¸ì‚¬ í˜ì´ì§€ì—ì„œ ì €ì¥í•œ ë°ì´í„°)
      const logs = JSON.parse(localStorage.getItem('kema_notification_logs') || '[]');

      // í˜„ì¬ ë¡œê·¸ì¸í•œ ê¸°ê´€ì˜ ë¡œê·¸ë§Œ í•„í„°ë§
      const orgLogs = logs.filter(log => log.organization_id === CURRENT_ORGANIZATION_ID);

      if (orgLogs.length === 0) {
        tbody.innerHTML = '';
        document.getElementById('noLogsMessage').style.display = 'block';
        return;
      }

      document.getElementById('noLogsMessage').style.display = 'none';

      tbody.innerHTML = orgLogs.map(log => {
        // ë³´í˜¸ì‚¬ ì •ë³´ ì°¾ê¸°
        const caregiver = caregivers.find(c => c.id === log.caregiver_id);
        const caregiverName = caregiver ? caregiver.name : 'ì•Œ ìˆ˜ ì—†ìŒ';

        // êµìœ¡ ì •ë³´ ì°¾ê¸°
        const education = mockEducationContents.find(e => e.id === log.education_content_id);
        const educationTitle = education ? education.title : 'ê¸°ë³¸ êµìœ¡';

        // ë‚ ì§œ í¬ë§·íŒ…
        const date = new Date(log.sent_at).toLocaleString('ko-KR');

        // ìƒíƒœ ìŠ¤íƒ€ì¼
        const statusBadge = log.status === 'sent'
          ? '<span class="badge badge-success">ë°œì†¡ ì„±ê³µ</span>'
          : '<span class="badge badge-danger">ë°œì†¡ ì‹¤íŒ¨</span>';

        const errorMessage = log.status === 'failed' && log.error_message
          ? `<span style="color:red; font-size:0.9em;">${log.error_message}</span>`
          : '-';

        return `
                <tr>
                    <td>${date}</td>
                    <td>${caregiverName}</td>
                    <td>${educationTitle}</td>
                    <td>${statusBadge}</td>
                    <td>${errorMessage}</td>
                </tr>
            `;
      }).join('');
    }

    // ë¡œê·¸ ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ë‹«ê¸°
    document.getElementById('logModal').addEventListener('click', (e) => {
      if (e.target.id === 'logModal') closeLogModal();
    });

    /* =========================================
       ì—‘ì…€ ì¼ê´„ ë“±ë¡ ê¸°ëŠ¥
       ========================================= */

    // ì—‘ì…€ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ
    function downloadExcelTemplate() {
      const headers = "ì„±ëª…,ì—°ë½ì²˜,ìƒë…„ì›”ì¼(YYYY-MM-DD),ìê²©ì¦ë²ˆí˜¸,ì…ì‚¬ì¼(YYYY-MM-DD)\n";
      const sampleData = "í™ê¸¸ë™,010-1234-5678,1980-01-01,CG-2024-00001,2024-01-01\n";
      const csvContent = "\uFEFF" + headers + sampleData;

      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement("a");
      const url = URL.createObjectURL(blob);
      link.setAttribute("href", url);
      link.setAttribute("download", "ìš”ì–‘ë³´í˜¸ì‚¬_ì¼ê´„ë“±ë¡_ì–‘ì‹.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // íŒŒì¼ ì„ íƒ íŠ¸ë¦¬ê±°
    function triggerExcelUpload() {
      document.getElementById('excelInput').click();
    }

    // ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬
    function handleExcelUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (e) {
        const content = e.target.result;
        processExcelData(content);
      };
      reader.readAsText(file, 'utf-8');

      // ì…ë ¥ê°’ ì´ˆê¸°í™” (ê°™ì€ íŒŒì¼ ë‹¤ì‹œ ì˜¬ë¦´ ìˆ˜ ìˆë„ë¡)
      event.target.value = '';
    }

    // CSV ë°ì´í„° íŒŒì‹± ë° ì €ì¥
    function processExcelData(csvText) {
      // ì¤„ ë‹¨ìœ„ë¡œ ë¶„ë¦¬ (ë¹ˆ ì¤„ ì œì™¸)
      const lines = csvText.split(/\r?\n/).filter(line => line.trim() !== "");
      if (lines.length <= 1) {
        alert("ë“±ë¡í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }

      // í—¤ë” ì œì™¸í•˜ê³  ë°ì´í„° ì¶”ì¶œ
      const newCaregivers = [];
      let nextId = caregivers.length > 0 ? Math.max(...caregivers.map(c => c.id)) + 1 : 1;

      for (let i = 1; i < lines.length; i++) {
        const columns = lines[i].split(',').map(col => col.trim());
        if (columns.length < 2) continue; // ìµœì†Œ ì´ë¦„, ì—°ë½ì²˜ëŠ” ìˆì–´ì•¼ í•¨

        const [name, phone, birthDate, certNo, hireDate] = columns;

        if (!name || !phone) continue;

        newCaregivers.push({
          id: nextId++,
          organization_id: CURRENT_ORGANIZATION_ID,
          name: name,
          phone: phone,
          birth_date: birthDate || null,
          certificate_number: certNo || null,
          hire_date: hireDate || null,
          status: 'active'
        });
      }

      if (newCaregivers.length > 0) {
        caregivers = [...caregivers, ...newCaregivers];
        localStorage.setItem('kema_caregivers', JSON.stringify(caregivers));

        loadCaregivers();
        updateSummaryCards();
        loadReportData();

        alert(`${newCaregivers.length}ëª…ì˜ ë³´í˜¸ì‚¬ê°€ ì¼ê´„ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.`);
      } else {
        alert("ë“±ë¡ ê°€ëŠ¥í•œ ìœ íš¨í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ì–‘ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
      }
    }
  </script>
</body>

</html>